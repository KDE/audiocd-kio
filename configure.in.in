AC_MSG_CHECKING(for cdparanoia libraries and headers)

AC_ARG_WITH(cdparanoia,
  [  --with-cdparanoia[=DIR] Compile in cdparanoia support [default=check]],
  [
    case "$withval" in
    yes)
      with_cdparanoia=CHECK
      ;;
    esac
  ],
  [
    with_cdparanoia=CHECK
  ]
)dnl

if test "x$with_cdparanoia" = "xCHECK" ; then
  with_cdparanoia=NOTFOUND
  search_incs="$kde_includes /usr/include /usr/local/include /usr/include/cdda /usr/local/include/cdda"
  AC_FIND_FILE(cdda_interface.h, $search_incs, para_incdir)
  if test -r $para_incdir/cdda_interface.h ; then
    test "x$para_incdir" != "x/usr/include" && CDPARANOIA_INCS="-I$para_incdir"
    with_cdparanoia=FOUND
  fi
  if test $with_cdparanoia = FOUND ; then
    with_cdparanoia=NOTFOUND
    # because of the horrible hack we need shared cdparanoia
    for ext in la so sl a ; do
      AC_FIND_FILE(libcdda_paranoia.$ext, $kde_libraries /usr/lib /usr/local/lib,
        para_libdir)
      if test -r $para_libdir/libcdda_paranoia.$ext ; then
        if test "x$para_libdir" != "x/usr/lib" ; then
          CDPARANOIA_LIBS="-L$para_libdir "
	  test "$USE_RPATH" = yes && CDPARANOIA_RPATH="-R $para_libdir"
        fi
        CDPARANOIA_LIBS="${CDPARANOIA_LIBS} -lcdda_paranoia -lcdda_interface"
	with_cdparanoia=FOUND
	# a.out shared libs don't have .so files, but .so.*
	if test $ext = a &&
	   ls $para_libdir | grep "^libcdda_paranoia.so.*" 2>&1 >/dev/null; then
          ext=so
        fi
        break
      fi
    done
    if test "$with_cdparanoia" = FOUND; then
      if test "$ext" = la; then
        grep "^library_names='.*[a-z].*'" $para_libdir/libcdda_paranoia.$ext 2>&1 > /dev/null || with_cdparanoia=NOTFOUND
      fi
      test "$ext" = a && with_cdparanoia=NOTFOUND
      test "$with_cdparanoia" = NOTFOUND && cdparanoia_only_static=yes
      # beware, that we don't reset CDPARANOIA_*
    fi
  fi
fi

if test "x$cdparanoia_only_static" = xyes; then
  AC_DEFINE_UNQUOTED(CDPARANOIA_STATIC, 1,
    [Define if you only have a static cdparanoia])
fi

case "$with_cdparanoia" in
no) AC_MSG_RESULT(no) ;;
NOTFOUND) AC_MSG_RESULT(searched but not found) ;;
*)
  if test "x$with_cdparanoia" = "xFOUND" ; then
    AC_MSG_RESULT(incs=$para_incdir libs=$para_libdir)
  else
    AC_MSG_RESULT($with_cdparanoia)
    CDPARANOIA_ROOT="$with_cdparanoia"
    if test "x$CDPARANOIA_ROOT" != "x/usr" ; then
      CDPARANOIA_INCS="-I${CDPARANOIA_ROOT}/include"
      CDPARANOIA_LIBS="-L${CDPARANOIA_ROOT}/lib "
      if test "$USE_RPATH" = "yes" ; then
        CDPARANOIA_RPATH="-R ${CDPARANOIA_ROOT}/lib"
      fi
    fi
    CDPARANOIA_LIBS="${CDPARANOIA_LIBS} -lcdda_paranoia -lcdda_interface"
  fi
  AC_DEFINE_UNQUOTED(HAVE_CDPARANOIA, 1, [Define if you have cdparanoia])
  AUDIOCD_SUBDIR="audiocd"
  ;;
esac

AC_SUBST(CDPARANOIA_INCS)
AC_SUBST(CDPARANOIA_LIBS)
AC_SUBST(CDPARANOIA_RPATH)
AM_CONDITIONAL(include_kioslave_audiocd, test -n "$AUDIOCD_SUBDIR")

AC_MSG_CHECKING(for lame library and header)

AC_ARG_WITH(lame,
  [  --with-lame[=DIR]	  Compile in Lame MP3 support [default=check]],
  [
    case "$withval" in
    yes) with_lame=CHECK ;;
    esac
  ],
  [ with_lame=CHECK ]
)dnl
AC_ARG_ENABLE(lametest,
  [  --disable-lametest    Do not try to compile and run a test Lame MP3 program], , enable_lametest=yes)

if test "x$with_lame" = "xCHECK" ; then
  with_lame=NOTFOUND
  search_incs="/usr/local/include $kde_includes /usr/include"
  AC_FIND_FILE(lame/lame.h, $search_incs, lame_incdir)
  if test -r $lame_incdir/lame/lame.h ; then
    test "x$lame_incdir" != "x/usr/include" && LAME_INCS="-I$lame_incdir"
    with_lame=FOUND
  fi
  if test $with_lame = FOUND ; then
    with_lame=NOTFOUND
    for ext in la so sl a ; do
      AC_FIND_FILE(libmp3lame.$ext, /usr/local/lib $kde_libraries /usr/lib,
        lame_libdir)
      if test -r $lame_libdir/libmp3lame.$ext ; then
        if test "x$lame_libdir" != "x/usr/lib" ; then
          LAME_LIBS="-L$lame_libdir "
	  test "$USE_RPATH" = yes && LAME_RPATH="-R $lame_libdir"
        fi
        LAME_LIBS="${LAME_LIBS}-lmp3lame -lm"
	with_lame=FOUND
        break
      fi
    done
  fi
fi

case "$with_lame" in
no) AC_MSG_RESULT(no) ;;
NOTFOUND) AC_MSG_RESULT(searched but not found) ;;
*)
  if test "x$with_lame" = "xFOUND" ; then
    msg="incs=$lame_incdir libs=$lame_libdir"
  else
    msg="$with_lame"
    LAME_ROOT="$with_lame"
    if test "x$LAME_ROOT" != "x/usr" ; then
      LAME_INCS="-I${LAME_ROOT}/include"
      LAME_LIBS="-L${LAME_ROOT}/lib "
      if test "$USE_RPATH" = "yes" ; then
        LAME_RPATH="-R ${LAME_ROOT}/lib"
      fi
    fi
    LAME_LIBS="${LAME_LIBS}-lmp3lame -lm"
  fi
  non_compile=no
  if test "x$enable_lametest" = xyes ; then
    ac_save_CPPFLAGS="$CPPFLAGS"
    ac_save_LIBS="$LIBS"
    CPPFLAGS="$CPPFLAGS $all_includes $LAME_INCS"
    LIBS="$LIBS $all_libraries $LAME_LIBS"
    rm -f conf.lametest conf.wrongver
	AC_LANG_SAVE
dnl lame headers use C++ style comments, which fails with the flags in
dnl effect when compiling with --enable-debug
	AC_LANG_CPLUSPLUS
    AC_TRY_RUN([
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <lame/lame.h>

int main ()
{
  lame_version_t v;
  get_lame_version_numerical (&v);
  if (v.major>3 || (v.major==3 && v.minor>88)) {
    system("touch conf.lametest");
    return 0;
  } else {
    system("touch conf.wrongver");
    return 1;
  }
}
], , non_compile=yes , [echo $ac_n "cross compiling; assumed OK... $ac_c"])
	AC_LANG_RESTORE
    CPPFLAGS="$ac_save_CPPFLAGS"
    LIBS="$ac_save_LIBS"
    # bogus return value, but it _did_ run correctly
    test -f conf.lametest && non_compile=no
    # Set the flag for configure.in.bot
    test -f conf.wrongver && lame_wrong_version=yes
    rm -f conf.lametest conf.wrongver
  fi
  if test "$non_compile" = no ; then
    AC_MSG_RESULT($msg)
    AC_DEFINE_UNQUOTED(HAVE_LAME, 1, [Define if you have lame])
    KCM_AUDIOCD="kcmaudiocd"
  else
    AC_MSG_RESULT(no (but first try gave $msg))
    if test -z "$lame_wrong_version"; then
      # only do this test, if it really didn't run
      echo "*** Could not run Lame test program, checking why..."
      CPPFLAGS="$CPPFLAGS $all_includes $LAME_INCS"
      LIBS="$LIBS $all_libraries $LAME_LIBS"
      AC_TRY_LINK([
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <lame/lame.h>
], [
  lame_version_t v;
  get_lame_version_numerical (&v);
  return 0;
],
[ echo "*** The test program compiled, but did not run. This usually means"
echo "*** that the run-time linker is not finding Lame or finding the wrong"
echo "*** version of Lame. If it is not finding Lame, you'll need to set your"
echo "*** LD_LIBRARY_PATH environment variable, or edit /etc/ld.so.conf to point"
echo "*** to the installed location  Also, make sure you have run ldconfig if that"
echo "*** is required on your system"
echo "***"
echo "*** If you have an old version installed, it is best to remove it, although"
echo "*** you may also be able to get things to work by modifying LD_LIBRARY_PATH"], [
echo "*** The test program failed to compile or link. See the file config.log for the"
echo "*** exact error that occured. This usually means Lame was incorrectly installed"
echo "*** or that you have moved Lame since it was installed." ])
      # ac_save_* still set, because this else part is only entered if the
      # enable_lametest was yes, in which case also ac_save_* was set.
      CPPFLAGS="$ac_save_CPPFLAGS"
      LIBS="$ac_save_LIBS"
    fi
    LAME_INCS=
    LAME_LIBS=
    LAME_RPATH=
  fi
  ;;
esac

AC_SUBST(LAME_INCS)
AC_SUBST(LAME_LIBS)
AC_SUBST(LAME_RPATH)
AC_SUBST(KCM_AUDIOCD)

AM_CONDITIONAL(include_kcm_audiocd, test -n "$KCM_AUDIOCD")
if test -z "$KAUDIOCREATOR"; then
    DO_NOT_COMPILE="$DO_NOT_COMPILE kaudiocreator"
fi

